---
git title: "iPhone iPad and Macbook Index Cleaning and Analysis"
author: "Alejandro Tortosa, Sergi Poy"
date: '2023-01-12'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stringr)
library(dplyr)
library(ggplot2)
```

# Tipologia i cicle de vida de les dades · Pràctica 2
# Neteja i Anàlisi de Dades: iPhone, iPad and Macbook Index
### Alejandro Tortosa Molla i Sergi Poy Garcia

## 1. Descripció del dataset
Utilitzem els datasets que vam extreure a la pràctica anterior, del Iphone Ipad and Macbook Index.
Per a poder realitzar l'Índex haurem de fusionar-los e integrar les dades.
Igual que el Big Mac Index volem tenir una comparativa de paritat de poder adquisitiu pero utilitzant com a referència els products d’Apple, per a poder tenir com a referència també un producte icònic, que no sigui del mercat de la restauració sinó de la tecnología, recordem que Apple representa una part molt important de la venda de mòbils a nivell global amb el seu mòbil insígnia iPhone (https://gs.statcounter.com/vendor-market-share/mobile).

## 2. Integracció i selecció

Per al nostre projecte el que farem serà treballar amb els 3 datasets que vam obtenir en la pràctica anterior:


- average_monthly_salary_index.csv: Aquí tenim el salari mitjà mensual en euros o en dolars i clasificat per país.
- world_currencies.csv: Tenim l’abreviatura de totes les monedes i la seva equivalència en euros o dolars.
- preus_mac_ipad_iphone.csv: Finalment en aquest arxiu tenim totes les dades de tots els models de Macbook, iPad i iPhone amb el seu identificatiu. Tenim a més el país on es ven cada model, així com una columna amb al divisa en la que está el preu de cada dispositiu.

Obtenim així totes les dades importants i representatives a l’hora de voler elaborar l’índex com a objectiu de la pràctica.
Però per a aconseguir l'objectiu les haurem de fusionar en un sol dataset. L'arxiu troncal a partir del qual treballarem és el dels preus_mac_ipad_iphone.csv:

Primer fusionem preus_mac_ipad_iphone.csv amb world_currencies.csv a partir de la columna Currency.
Després fusionem el dataset resultant amb average_monthly_salary_index.csv a partir de la columna Country.

Això però ho farem després de la neteja.


## 3. Neteja de les dades

La neteja de les dades va ítegrament relacionada amb la integració d'aquestes, ja que per a poder-les fusionar amb èxit em de veure que els valors entre columnes coincideixin. Per a més tard quan aquesta integració es faci amb èxit poguem reduir la quantitat de columnes i veure si tenim una cohesió entre elles.



Per tant anem a treballar amb les dades i les carreguem a R:
```{r}
preus_csv <- read.csv("../csv/preus_mac_ipad_iphone.csv")
salaris_csv <- read.csv("../csv/average_monthly_salary_index.csv")
divises_csv <- read.csv("../csv/world_currencies.csv")  
```


Com que la columna de "price" té aquest format: "{'fullPrice': 499990.0}"
Hem d'extreure amb gsub i una RegEx el preu, modifiquem amb as.numeric el seu format, per a fer un anàlisi ha de ser un numèric, no un "chr".
```{r}
class(preus_csv$price)
preus_csv$price <- as.numeric(gsub("[^[:digit:].]", "", preus_csv$price))
head(preus_csv)
```

També hem d'extreure el país de la columna "store":

```{r}
preus_csv$store <- gsub("^AOS: (.*) [Consumer|consumer].*$", "\\1", preus_csv$store)
unique(preus_csv$store)
```
Com podem veure amb els valors unics el filtratge no ha sortit del tot bé, i tot i així els valors no coincideixen amb un equivalent per a fer un "merge" amb salaris_csv, per exemple de valor tenim "UK" però a salaris_csv tenim "United Kingdom", per tant utilitzarem la funció case_when() per a modificar els valors que no coincideixen.

Aparentment es un treball tediós però així ens asegurem que les dades estiguin ven integrades i tinguin coherència entre elles. 
Crearem una nova columna on canviarem només el nom en els casos necessaris, en els que no el valor serà el mateix.

```{r}
preus_csv$Country <- case_when(
  preus_csv$store == "German" ~ "Germany",
  preus_csv$store == "Austrian" ~ "Austria",
  preus_csv$store == "Hong Kong Chinese" ~ "Hong Kong",
  preus_csv$store == "Czech" ~ "Czech Republic",
  preus_csv$store == "Korea" ~ "South Korea",
  preus_csv$store == "French Canada" ~ "Canada",
  preus_csv$store == "Finnish" ~ "Finland",
  preus_csv$store == "Irish" ~ "Ireland",
  preus_csv$store == "NZ" ~ "New Zealand",
  preus_csv$store == "US" ~ "United States",
  preus_csv$store == "Belgium French" ~ "Belgium",
  preus_csv$store == "Swedish" ~ "Sweden",
  preus_csv$store == "UAE" ~ "United Arab Emirates",
  preus_csv$store == "Belgium Flemish" ~ "Belgium",
  preus_csv$store == "IN" ~ "India",
  preus_csv$store == "UK" ~ "United Kingdom",
  preus_csv$store == "Swiss French" ~ "Switzerland",
  preus_csv$store == "Italian" ~ "Italy",
  preus_csv$store == "AOS: Apple Store Luxembourg" ~ "Luxembourg",
  preus_csv$store == "Swiss German" ~ "Switzerland",
  preus_csv$store == "French" ~ "France",
  preus_csv$store == "HongKong" ~ "Hong Kong",
  preus_csv$store == "Dutch" ~ "Netherlands",
  TRUE ~ preus_csv$store
)
print(preus_csv)
```

Donada la neteja anterior per a preparar les dades per a la fusió agafem i fem un "merge" dels 3 Csv's:
```{r}
preus_divises_csv <- merge(preus_csv, divises_csv, by.x = "currency", by.y = "Currency")
apple_index_raw <- merge(preus_divises_csv, salaris_csv, by.x = "Country", by.y = "Country")

print(apple_index_raw)

```


Ara és hora de fer l'index, preparem les dues columnes que estaven com a "chr" i les pasem a numèric. Posteriorment amb l'equivalència de l'Euro creem la fòrmula que ens dona els mesos que hem de treballar per a poder comprar un producte Apple en determinat pais.
La fòrmula és:
Preu producte apple / (Sou mitjà mensual * Canvi de divisa a 1€)
```{r}
class(apple_index_raw$X1.EUR.in.Currency)
class(apple_index_raw$X1.USD.in.Currency)

apple_index_raw$X1.EUR.in.Currency <- as.numeric(apple_index_raw$X1.EUR.in.Currency)
apple_index_raw$X1.USD.in.Currency <- as.numeric(apple_index_raw$X1.USD.in.Currency)

apple_index_raw$months_to_buy_product <- apple_index_raw$price / (apple_index_raw$EUR.Average.Monthly.Salary * apple_index_raw$X1.EUR.in.Currency)
print(apple_index_raw)
```

Finalment agafem un subset amb només els productes que coincideixen amb el model d'iPhone que volem analitzar i ho plotejem:
```{r}
iphone14PM_index <- subset(apple_index_raw, apple_index_raw$name == "iPhone 14 Pro Max 128GB Silver")


ggplot(iphone14PM_index, aes(x=Country, y=months_to_buy_product)) + 
  geom_bar(stat="identity") +
  xlab("Country") +
  ylab("Months to buy iPhone") +
  ggtitle("Months to buy iPhone 14 Pro Max 128GB Silver by country")
```


## Neteja de les dades.
Busquem si hi ha cap valor nul al dataset:
```{r}
anyNA(apple_index_raw)
```

